<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>üå§Ô∏è Weather Prediction Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
  <style>
    body {
      font-family: Arial;
      padding: 20px;
      background: #f0f8ff;
    }
    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }
    #backBtn {
      margin-bottom: 20px;
      padding: 8px 16px;
      background: #3498db;
      color: white;
      border: none;
      cursor: pointer;
    }
    #backBtn:hover {
      background: #2980b9;
    }
    .dashboard-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }
    .chart-card {
      background: white;
      border-radius: 8px;
      padding: 15px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .chart-container {
      position: relative;
      height: 300px;
      width: 100%;
    }
    .prediction-text {
      font-size: 16px;
      margin-top: 10px;
      font-weight: bold;
      color: #2c3e50;
      text-align: center;
    }
    #location {
      text-align: center;
      font-size: 18px;
      margin-bottom: 20px;
    }
    @media (max-width: 768px) {
      .dashboard-container {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <button id="backBtn" onclick="goBack()">‚Üê Back</button>
  <h1>üå§Ô∏è Weather Forecast Dashboard</h1>
  <p id="location">City: {{ city }}</p>

  <div class="dashboard-container">
    <div class="chart-card">
      <h3>Temperature Forecast</h3>
      <p style="text-align:center; font-size:14px; margin-top:-10px; margin-bottom:10px;">
        Temperature - Line chart with gradient fill
      </p>
      <div class="chart-container">
        <canvas id="tempChart"></canvas>
      </div>
      <p id="predicted-temp" class="prediction-text">Loading temperature prediction...</p>
    </div>

    <div class="chart-card">
      <h3>Humidity Forecast</h3>
      <p style="text-align:center; font-size:14px; margin-top:-10px; margin-bottom:10px;">
        Humidity - Radar chart
      </p>
      <div class="chart-container">
        <canvas id="humidityChart"></canvas>
      </div>
      <p id="predicted-humidity" class="prediction-text">Loading humidity prediction...</p>
    </div>

    <div class="chart-card">
      <h3>Air Quality Index</h3>
      <p style="text-align:center; font-size:14px; margin-top:-10px; margin-bottom:10px;">
        AQI - Bar chart with color-coded bars
      </p>
      <div class="chart-container">
        <canvas id="aqiChart"></canvas>
      </div>
      <p id="predicted-aqi" class="prediction-text">Loading AQI prediction...</p>
    </div>

    <div class="chart-card">
      <h3>Wind Speed Forecast</h3>
      <p style="text-align:center; font-size:14px; margin-top:-10px; margin-bottom:10px;">
        Wind Speed - Bubble chart (wind speed as bubble size)
      </p>
      <div class="chart-container">
        <canvas id="windspeedChart"></canvas>
      </div>
      <p id="predicted-windspeed" class="prediction-text">Loading wind speed prediction...</p>
    </div>
  </div>

  <script>
    let charts = {};
    const openWeatherKey = "9685f38713234d8851954d583ec9de70";
    const urlParams = new URLSearchParams(window.location.search);
    const cityParam = urlParams.get("city");
    const defaultCity = cityParam || "{{ city }}" || "Hyderabad";
    let cityName = defaultCity;

    function goBack() {
      window.location.href = "/";
    }

    document.addEventListener('DOMContentLoaded', () => {
      fetchWeatherData();
    });

    async function fetchWeatherData() {
      document.getElementById("location").innerText = `üìç City: ${cityName}`;
      try {
        // Fetch current weather
        const currentWeatherResponse = await fetch(
          `https://api.openweathermap.org/data/2.5/weather?q=${cityName}&appid=${openWeatherKey}&units=metric`
        );
        if (!currentWeatherResponse.ok) throw new Error(`Current weather fetch failed: ${currentWeatherResponse.status}`);
        const currentData = await currentWeatherResponse.json();
        cityName = currentData.name;
        const lat = currentData.coord.lat;
        const lon = currentData.coord.lon;

        // Fetch 5-day forecast
        const forecastResponse = await fetch(
          `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&appid=${openWeatherKey}&units=metric`
        );
        if (!forecastResponse.ok) throw new Error(`Forecast fetch failed: ${forecastResponse.status}`);
        const forecastData = await forecastResponse.json();

        // Fetch current AQI
        const aqiResponse = await fetch(
          `https://api.openweathermap.org/data/2.5/air_pollution?lat=${lat}&lon=${lon}&appid=${openWeatherKey}`
        );
        if (!aqiResponse.ok) throw new Error(`AQI fetch failed: ${aqiResponse.status}`);
        const aqiData = await aqiResponse.json();

        processWeatherData(currentData, forecastData, aqiData);
      } catch (err) {
        console.error(err);
        ['temp', 'humidity', 'aqi', 'windspeed'].forEach(type => {
          document.getElementById(`predicted-${type}`).innerText = " fetched weather data";
        });
      }
    }

    function processWeatherData(currentData, forecastData, aqiData) {
      const today = new Date();
      const labels = [today.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' })];
      const temps = [currentData.main.temp];
      const humidities = [currentData.main.humidity];
      const aqis = [aqiData.list[0].main.aqi];
      const winds = [currentData.wind.speed * 3.6]; // Convert m/s to km/h

      // Process forecast data for next 5 days
      const dailyData = {};
      forecastData.list.forEach(item => {
        const date = new Date(item.dt * 1000);
        const dateStr = date.toLocaleDateString('en-US', { month: 'numeric', day: 'numeric' });
        if (!dailyData[dateStr]) {
          dailyData[dateStr] = {
            temp: item.main.temp,
            humidity: item.main.humidity,
            wind: item.wind.speed * 3.6,
            count: 1
          };
        } else {
          dailyData[dateStr].temp += item.main.temp;
          dailyData[dateStr].humidity += item.main.humidity;
          dailyData[dateStr].wind += item.wind.speed * 3.6;
          dailyData[dateStr].count += 1;
        }
      });

      // Average the forecast data per day
      Object.keys(dailyData).slice(0, 5).forEach(date => {
        labels.push(date);
        temps.push(dailyData[date].temp / dailyData[date].count);
        humidities.push(dailyData[date].humidity / dailyData[date].count);
        winds.push(dailyData[date].wind / dailyData[date].count);
        aqis.push(aqis[0]); // AQI forecast not available, use current as placeholder
      });

      updateTemperatureChart(labels, temps);
      updateHumidityChart(labels, humidities);
      updateAqiChart(labels, aqis);
      updateWindspeedChart(labels, winds);

      predictTomorrow(temps, labels, "temperature");
      predictTomorrow(humidities, labels, "humidity");
      predictTomorrow(aqis, labels, "aqi");
      predictTomorrow(winds, labels, "windspeed");
    }

    function updateTemperatureChart(labels, values) {
      if (charts["tempChart"]) charts["tempChart"].destroy();
      const ctx = document.getElementById("tempChart").getContext("2d");
      const gradient = ctx.createLinearGradient(0, 0, 0, 300);
      gradient.addColorStop(0, 'rgba(255, 99, 132, 0.6)');
      gradient.addColorStop(1, 'rgba(54, 162, 235, 0.6)');

      charts["tempChart"] = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Temperature (¬∞C)',
            data: values,
            borderColor: 'rgba(255, 99, 132, 1)',
            backgroundColor: gradient,
            borderWidth: 3,
            fill: true,
            tension: 0.4,
            pointBackgroundColor: 'rgba(255, 99, 132, 1)',
            pointRadius: 5,
            pointHoverRadius: 7
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true, position: 'top' }, tooltip: { mode: 'index', intersect: false } },
          scales: {
            y: { beginAtZero: false, title: { display: true, text: 'Temperature (¬∞C)' } },
            x: { title: { display: true, text: 'Date' } }
          }
        }
      });
    }

    function updateHumidityChart(labels, values) {
      if (charts["humidityChart"]) charts["humidityChart"].destroy();
      const ctx = document.getElementById("humidityChart").getContext("2d");

      charts["humidityChart"] = new Chart(ctx, {
        type: 'radar',
        data: {
          labels,
          datasets: [{
            label: 'Humidity (%)',
            data: values,
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            borderWidth: 2,
            pointBackgroundColor: 'rgba(54, 162, 235, 1)',
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: true, position: 'top' } },
          scales: { r: { angleLines: { display: true }, suggestedMin: 0, suggestedMax: 100 } },
          elements: { line: { tension: 0.1 } }
        }
      });
    }

    function updateAqiChart(labels, values) {
      if (charts["aqiChart"]) charts["aqiChart"].destroy();
      const ctx = document.getElementById("aqiChart").getContext("2d");

      const backgroundColors = values.map(aqi => {
        const alpha = 0.7;
        return aqi === 1 ? `rgba(0, 200, 83, ${alpha})` :
               aqi === 2 ? `rgba(255, 235, 59, ${alpha})` :
               aqi === 3 ? `rgba(255, 152, 0, ${alpha})` :
               aqi === 4 ? `rgba(244, 67, 54, ${alpha})` :
               `rgba(156, 39, 176, ${alpha})`;
      });

      const borderColors = values.map(aqi => 
        aqi === 1 ? 'rgba(0, 200, 83, 1)' :
        aqi === 2 ? 'rgba(255, 235, 59, 1)' :
        aqi === 3 ? 'rgba(255, 152, 0, 1)' :
        aqi === 4 ? 'rgba(244, 67, 54, 1)' :
        'rgba(156, 39, 176, 1)'
      );

      charts["aqiChart"] = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'AQI Level',
            data: values,
            backgroundColor: backgroundColors,
            borderColor: borderColors,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: context => {
                  const aqi = context.raw;
                  const levels = ["Good", "Fair", "Moderate", "Poor", "Very Poor"];
                  return `AQI: ${aqi} (${levels[aqi - 1]})`;
                }
              }
            }
          },
          scales: {
            y: { beginAtZero: true, max: 5, title: { display: true, text: 'AQI Level' } },
            x: { title: { display: true, text: 'Date' } }
          }
        }
      });
    }

    function updateWindspeedChart(labels, values) {
      if (charts["windspeedChart"]) charts["windspeedChart"].destroy();
      const ctx = document.getElementById("windspeedChart").getContext("2d");

      const bubbleData = values.map((value, i) => ({ x: i + 1, y: value, r: Math.min(value * 2, 50) })); // Cap radius for visibility

      charts["windspeedChart"] = new Chart(ctx, {
        type: 'bubble',
        data: {
          labels,
          datasets: [{
            label: 'Wind Speed (km/h)',
            data: bubbleData,
            backgroundColor: 'rgba(75, 192, 192, 0.6)',
            borderColor: 'rgba(75, 192, 192, 1)',
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: true, position: 'top' },
            tooltip: { callbacks: { label: context => `Wind Speed: ${context.raw.y.toFixed(1)} km/h` } }
          },
          scales: {
            y: { beginAtZero: true, title: { display: true, text: 'Wind Speed (km/h)' } },
            x: {
              title: { display: true, text: 'Day' },
              ticks: { callback: (value, index) => labels[index] }
            }
          }
        }
      });
    }

    function predictTomorrow(values, labels, type) {
      // Use the next day's forecast value directly for precision
      const tomorrowValue = values[1]; // Second value is tomorrow
      const updateMap = {
        temperature: { text: `üå°Ô∏è Tomorrow: ${tomorrowValue.toFixed(1)}¬∞C`, chart: updateTemperatureChart, unit: '¬∞C' },
        humidity: { text: `üíß Tomorrow: ${tomorrowValue.toFixed(1)}%`, chart: updateHumidityChart, unit: '%' },
        aqi: { text: `üå´Ô∏è Tomorrow: ${["Good", "Fair", "Moderate", "Poor", "Very Poor"][Math.round(tomorrowValue) - 1]} (${Math.round(tomorrowValue)})`, chart: updateAqiChart, unit: '' },
        windspeed: { text: `üí® Tomorrow: ${tomorrowValue.toFixed(1)} km/h`, chart: updateWindspeedChart, unit: 'km/h' }
      };

      const { text, chart, unit } = updateMap[type];
      document.getElementById(`predicted-${type}`).innerText = text;
      chart([...labels, "Tomorrow"], [...values, tomorrowValue]);
      sendDataToBackend(cityName, type, tomorrowValue);
    }

    function sendDataToBackend(city, type, value) {
      fetch("http://127.0.0.1:5000/update-prediction", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ city, type, value: parseFloat(value) })
      })
      .then(res => {
        if (!res.ok) throw new Error(`HTTP error! Status: ${res.status}`);
        return res.json();
      })
      .then(data => console.log(`‚úÖ Sent ${type} prediction to backend:`, data))
      .catch(err => console.error(`‚ùå Error sending ${type} data:`, err));
    }
  </script>
</body>
</html>